## Copyright (C) 2007-2012 Roger While
## Copyright (C) 2014, 2015 Simon Sobisch
## Copyright (C) 2014, 2015 Edward Hart
## 
## This file is part of GNU Cobol.
## 
## The GNU Cobol compiler is free software: you can redistribute it
## and/or modify it under the terms of the GNU General Public License
## as published by the Free Software Foundation, either version 3 of the
## License, or (at your option) any later version.
## 
## GNU Cobol is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
## 
## You should have received a copy of the GNU General Public License
## along with GNU Cobol.  If not, see <http://www.gnu.org/licenses/>.

### GNU Cobol Test Suite


AT_SETUP([REPOSITORY])
AT_KEYWORDS([functions])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
       REPOSITORY.
           FUNCTION rxwfun
           FUNCTION pi e intrinsic
           .
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.
           DISPLAY PI.
           DISPLAY E.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY prog.cob], [0], [], [])

AT_CLEANUP


AT_SETUP([Intrinsic Funtions: number of arguments])
AT_KEYWORDS([functions])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.
           DISPLAY FUNCTION PI.
           DISPLAY FUNCTION PI ( ).
           DISPLAY FUNCTION PI (1).
           DISPLAY FUNCTION ABS.
           DISPLAY FUNCTION ABS (1).
           DISPLAY FUNCTION ABS (1, 2).
           DISPLAY FUNCTION DAY-TO-YYYYDDD.
           DISPLAY FUNCTION DAY-TO-YYYYDDD (6000).
           DISPLAY FUNCTION DAY-TO-YYYYDDD (6000,50).
           DISPLAY FUNCTION DAY-TO-YYYYDDD (6000,50,1600).
           DISPLAY FUNCTION DAY-TO-YYYYDDD (6000,50,1600,500).
           DISPLAY FUNCTION MAX ().
           DISPLAY FUNCTION MAX (6000).
           DISPLAY FUNCTION SUBSTITUTE ('A' 'B' 'C' 'D').
           STOP RUN.
])

AT_CHECK([$COMPILE -o prog prog.cob], [1], [],
[prog.cob: 10: Error: FUNCTION 'PI' has wrong number of arguments
prog.cob: 11: Error: FUNCTION 'ABS' has wrong number of arguments
prog.cob: 13: Error: FUNCTION 'ABS' has wrong number of arguments
prog.cob: 14: Error: FUNCTION 'DAY-TO-YYYYDDD' has wrong number of arguments
prog.cob: 18: Error: FUNCTION 'DAY-TO-YYYYDDD' has wrong number of arguments
prog.cob: 19: Error: FUNCTION 'MAX' has wrong number of arguments
prog.cob: 21: Error: FUNCTION 'SUBSTITUTE' has wrong number of arguments
])

AT_CLEANUP


AT_SETUP([Intrinsic Funtions: reference modification])
AT_KEYWORDS([functions])

# the following should be checked, currently doesn't work
#AT_DATA([prog.cob], [
#       IDENTIFICATION   DIVISION.
#       PROGRAM-ID.      prog.
#       ENVIRONMENT DIVISION.
#       DATA             DIVISION.
#       WORKING-STORAGE  SECTION.
#       PROCEDURE        DIVISION.
#           DISPLAY FUNCTION CHAR (66)(1:2).
#           DISPLAY FUNCTION NUMVAL-C (123)(1:2).
#           DISPLAY FUNCTION REVERSE ("TESTME")(20:1).
#           DISPLAY FUNCTION REVERSE ("TESTME")(-1:1).
#           DISPLAY FUNCTION REVERSE ("TESTME")(1:0).
#           STOP RUN.
#])
#
#AT_CHECK([$COMPILE -o prog prog.cob], [1], [],
#[prog.cob: 8: Error: FUNCTION 'PI' can not have reference modification
#prog.cob: 9: Error: FUNCTION 'NUMVAL-C' can not have reference modification
#prog.cob: 10: Error: FUNCTION 'REVERSE' has invalid reference modification
#prog.cob: 11: Error: FUNCTION 'REVERSE' has invalid reference modification
#prog.cob: 12: Error: FUNCTION 'REVERSE' has invalid reference modification
#])

# test what is in already...
AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.
           DISPLAY FUNCTION REVERSE ("TESTME")(-1:1).
           DISPLAY FUNCTION REVERSE ("TESTME")(1:0).
           STOP RUN.
])

AT_CHECK([$COMPILE -o prog prog.cob], [1], [],
[prog.cob: 8: Error: FUNCTION 'REVERSE' has invalid reference modification
prog.cob: 9: Error: FUNCTION 'REVERSE' has invalid reference modification
])

AT_CLEANUP


AT_SETUP([Intrinsic Funtions: Parameter type])
AT_KEYWORDS([functions])

# TODO: Add more tests

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.
           DISPLAY FUNCTION ABS ('1').
           STOP RUN.
])

AT_CHECK([$COMPILE -o prog prog.cob], [1], [],
[prog.cob: 8: Error: FUNCTION 'ABS' has invalid parameter
])

AT_CLEANUP


AT_SETUP([Invalid formatted date/time args])
AT_KEYWORDS([functions FORMATTED-DATE FORMATTED-CURRENT-DATE FORMATTED-TIME FORMATTED-DATETIME INTEGER-OF-FORMATTED-DATE SECONDS-FROM-FORMATTED-TIME])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  format-str         PIC X(8) VALUE "YYYYMMDD".
       01  Date-Format        CONSTANT "YYYYMMDD".
       01  Time-Format        CONSTANT "hhmmss".
       01  Datetime-Format    CONSTANT "YYYYMMDDThhmmss".
       PROCEDURE        DIVISION.
      *>   Test wrong formats
           DISPLAY FUNCTION FORMATTED-DATE ( "YYYYWWWD", 1 )
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-TIME ( "HHMMSS", 1)
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-DATETIME
                ( "YYYYWWWDTHHMMSS", 1, 1)
           END-DISPLAY

      *>   Test format in variable
           DISPLAY FUNCTION FORMATTED-DATE ( format-str, 1)
           END-DISPLAY

      *>   Test incompatible formats
           DISPLAY FUNCTION FORMATTED-CURRENT-DATE (Date-Format)
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-CURRENT-DATE (Time-Format)
           END-DISPLAY

           DISPLAY FUNCTION FORMATTED-DATE ( Time-Format, 1)
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-DATE ( Datetime-Format, 1)
           END-DISPLAY

           DISPLAY FUNCTION FORMATTED-TIME ( Date-Format, 1)
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-TIME ( Datetime-Format, 1)
           END-DISPLAY

           DISPLAY FUNCTION FORMATTED-DATETIME ( Date-Format, 1, 1)
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-DATETIME ( Time-Format, 1, 1)
           END-DISPLAY

           DISPLAY FUNCTION INTEGER-OF-FORMATTED-DATE ( Time-Format, 1)
           END-DISPLAY
 
           DISPLAY FUNCTION SECONDS-FROM-FORMATTED-TIME
               ( Date-Format, 1)
           END-DISPLAY

      *>   Time format with more than 9 decimal places.
           DISPLAY FUNCTION FORMATTED-TIME ( "hhmmss.ssssssssss", 1)
           END-DISPLAY

           STOP RUN.
])

AT_CHECK([$COMPILE -o prog prog.cob], [1], [],
[prog.cob: 12: Error: FUNCTION 'FORMATTED-DATE' has invalid date/time format
prog.cob: 14: Error: FUNCTION 'FORMATTED-TIME' has invalid date/time format
prog.cob: 16: Error: FUNCTION 'FORMATTED-DATETIME' has invalid date/time format
prog.cob: 21: Warning: FUNCTION 'FORMATTED-DATE' has format in variable
prog.cob: 25: Error: FUNCTION 'FORMATTED-CURRENT-DATE' has invalid date/time format
prog.cob: 27: Error: FUNCTION 'FORMATTED-CURRENT-DATE' has invalid date/time format
prog.cob: 30: Error: FUNCTION 'FORMATTED-DATE' has invalid date/time format
prog.cob: 32: Error: FUNCTION 'FORMATTED-DATE' has invalid date/time format
prog.cob: 35: Error: FUNCTION 'FORMATTED-TIME' has invalid date/time format
prog.cob: 37: Error: FUNCTION 'FORMATTED-TIME' has invalid date/time format
prog.cob: 40: Error: FUNCTION 'FORMATTED-DATETIME' has invalid date/time format
prog.cob: 42: Error: FUNCTION 'FORMATTED-DATETIME' has invalid date/time format
prog.cob: 45: Error: FUNCTION 'INTEGER-OF-FORMATTED-DATE' has invalid date/time format
prog.cob: 48: Error: FUNCTION 'SECONDS-FROM-FORMATTED-TIME' has invalid date/time format
prog.cob: 53: Error: FUNCTION 'FORMATTED-TIME' has invalid date/time format
])

AT_CLEANUP

AT_SETUP([Invalid formats w/ DECIMAL-POINT IS COMMA])
AT_KEYWORDS([functions FORMATTED-TIME FORMATTED-DATETIME])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT      DIVISION.
       CONFIGURATION    SECTION.
       SPECIAL-NAMES.
           DECIMAL-POINT IS COMMA.
       PROCEDURE        DIVISION.
           DISPLAY FUNCTION FORMATTED-TIME ("hhmmss,ss", 1)
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-DATETIME
                       ("YYYYMMDDThhmmss,ss", 1, 1)
           END-DISPLAY

           DISPLAY FUNCTION FORMATTED-TIME ("hhmmss.ss", 1)
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-DATETIME
                       ("YYYYMMDDThhmmss.ss", 1, 1)
           END-DISPLAY

           STOP RUN.
])

AT_CHECK([$COMPILE -o prog prog.cob], [1], [],
[prog.cob: 15: Error: FUNCTION 'FORMATTED-TIME' has invalid date/time format
prog.cob: 17: Error: FUNCTION 'FORMATTED-DATETIME' has invalid date/time format
])

AT_CLEANUP



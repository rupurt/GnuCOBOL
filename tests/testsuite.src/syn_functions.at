## Copyright (C) 2007-2012 Roger While
## Copyright (C) 2014, 2015 Simon Sobisch
## Copyright (C) 2014, 2015 Edward Hart
## 
## This file is part of GNU Cobol.
## 
## The GNU Cobol compiler is free software: you can redistribute it
## and/or modify it under the terms of the GNU General Public License
## as published by the Free Software Foundation, either version 3 of the
## License, or (at your option) any later version.
## 
## GNU Cobol is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
## 
## You should have received a copy of the GNU General Public License
## along with GNU Cobol.  If not, see <http://www.gnu.org/licenses/>.

### GNU Cobol Test Suite


AT_SETUP([REPOSITORY])
AT_KEYWORDS([functions])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
       REPOSITORY.
           FUNCTION rxwfun
           FUNCTION pi e intrinsic
           .
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.
           DISPLAY PI.
           DISPLAY E.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY prog.cob], [0], [], [])

AT_CLEANUP


AT_SETUP([Invalid formatted date/time args])
AT_KEYWORDS([functions FORMATTED-DATE FORMATTED-CURRENT-DATE FORMATTED-TIME FORMATTED-DATETIME INTEGER-OF-FORMATTED-DATE SECONDS-FROM-FORMATTED-TIME])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  format-str         PIC X(8) VALUE "YYYYMMDD".
       01  Date-Format        CONSTANT "YYYYMMDD".
       01  Time-Format        CONSTANT "hhmmss".
       01  Datetime-Format    CONSTANT "YYYYMMDDThhmmss".
       PROCEDURE        DIVISION.
      *>   Test wrong formats
           DISPLAY FUNCTION FORMATTED-DATE ( "YYYYWWWD", 1 )
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-TIME ( "HHMMSS", 1)
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-DATETIME
                ( "YYYYWWWDTHHMMSS", 1, 1)
           END-DISPLAY

      *>   Test format in variable
           DISPLAY FUNCTION FORMATTED-DATE ( format-str, 1)
           END-DISPLAY

      *>   Test incompatible formats
           DISPLAY FUNCTION FORMATTED-CURRENT-DATE (Date-Format)
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-CURRENT-DATE (Time-Format)
           END-DISPLAY

           DISPLAY FUNCTION FORMATTED-DATE ( Time-Format, 1)
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-DATE ( Datetime-Format, 1)
           END-DISPLAY

           DISPLAY FUNCTION FORMATTED-TIME ( Date-Format, 1)
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-TIME ( Datetime-Format, 1)
           END-DISPLAY

           DISPLAY FUNCTION FORMATTED-DATETIME ( Date-Format, 1, 1)
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-DATETIME ( Time-Format, 1, 1)
           END-DISPLAY

           DISPLAY FUNCTION INTEGER-OF-FORMATTED-DATE ( Time-Format, 1)
           END-DISPLAY
 
           DISPLAY FUNCTION SECONDS-FROM-FORMATTED-TIME
               ( Date-Format, 1)
           END-DISPLAY

      *>   Test offset time formats without offset parameter.
           DISPLAY FUNCTION FORMATTED-TIME ( "hhmmssZ", 1) END-DISPLAY
           DISPLAY FUNCTION FORMATTED-TIME ( "hhmmss+hhmm", 1)
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-DATETIME
               ( "YYYYMMDDThhmmssZ", 1, 1)
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-DATETIME
               ( "YYYYMMDDThhmmss+hhmm", 1, 1)
           END-DISPLAY

      *>   Time format with more than 9 decimal places.
           DISPLAY FUNCTION FORMATTED-TIME ( "hhmmss.ssssssssss", 1)
           END-DISPLAY

           STOP RUN.
])

AT_CHECK([$COMPILE -o prog prog.cob], [1], [],
[prog.cob: 12: Error: FUNCTION 'FORMATTED-DATE' has invalid date/time format
prog.cob: 14: Error: FUNCTION 'FORMATTED-TIME' has invalid date/time format
prog.cob: 16: Error: FUNCTION 'FORMATTED-DATETIME' has invalid date/time format
prog.cob: 21: Warning: FUNCTION 'FORMATTED-DATE' has format in variable
prog.cob: 25: Error: FUNCTION 'FORMATTED-CURRENT-DATE' has invalid date/time format
prog.cob: 27: Error: FUNCTION 'FORMATTED-CURRENT-DATE' has invalid date/time format
prog.cob: 30: Error: FUNCTION 'FORMATTED-DATE' has invalid date/time format
prog.cob: 32: Error: FUNCTION 'FORMATTED-DATE' has invalid date/time format
prog.cob: 35: Error: FUNCTION 'FORMATTED-TIME' has invalid date/time format
prog.cob: 37: Error: FUNCTION 'FORMATTED-TIME' has invalid date/time format
prog.cob: 40: Error: FUNCTION 'FORMATTED-DATETIME' has invalid date/time format
prog.cob: 42: Error: FUNCTION 'FORMATTED-DATETIME' has invalid date/time format
prog.cob: 45: Error: FUNCTION 'INTEGER-OF-FORMATTED-DATE' has invalid date/time format
prog.cob: 48: Error: FUNCTION 'SECONDS-FROM-FORMATTED-TIME' has invalid date/time format
prog.cob: 53: Error: FUNCTION 'FORMATTED-TIME' does not have an offset time
prog.cob: 54: Error: FUNCTION 'FORMATTED-TIME' does not have an offset time
prog.cob: 56: Error: FUNCTION 'FORMATTED-DATETIME' does not have an offset time
prog.cob: 59: Error: FUNCTION 'FORMATTED-DATETIME' does not have an offset time
prog.cob: 64: Error: FUNCTION 'FORMATTED-TIME' has invalid date/time format
])

AT_CLEANUP

AT_SETUP([Invalid formats w/ DECIMAL-POINT IS COMMA])
AT_KEYWORDS([functions FORMATTED-TIME FORMATTED-DATETIME])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT      DIVISION.
       CONFIGURATION    SECTION.
       SPECIAL-NAMES.
           DECIMAL-POINT IS COMMA.
       PROCEDURE        DIVISION.
           DISPLAY FUNCTION FORMATTED-TIME ("hhmmss,ss", 1)
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-DATETIME
                       ("YYYYMMDDThhmmss,ss", 1, 1)
           END-DISPLAY

           DISPLAY FUNCTION FORMATTED-TIME ("hhmmss.ss", 1)
           END-DISPLAY
           DISPLAY FUNCTION FORMATTED-DATETIME
                       ("YYYYMMDDThhmmss.ss", 1, 1)
           END-DISPLAY

           STOP RUN.
])

AT_CHECK([$COMPILE -o prog prog.cob], [1], [],
[prog.cob: 15: Error: FUNCTION 'FORMATTED-TIME' has invalid date/time format
prog.cob: 17: Error: FUNCTION 'FORMATTED-DATETIME' has invalid date/time format
])

AT_CLEANUP


